import os
import pandas as pd
import requests
from io import StringIO
from django.core.management.base import BaseCommand

MERGED_CSV_PATH = "datasets/train/merged_urls_dataset.csv"

class Command(BaseCommand):
    help = "Fetch URLHaus recent URLs and append to merged_urls_dataset.csv"

    def handle(self, *args, **options):
        self.stdout.write("Fetching URLHaus dataset...")
        urlhaus_df = self.fetch_urlhaus()
        self.append_to_merged_csv(urlhaus_df)
        self.stdout.write(self.style.SUCCESS("Done!"))

    def fetch_urlhaus(self):
        url = "https://urlhaus.abuse.ch/downloads/csv_recent/"
        r = requests.get(url)
        r.raise_for_status()

        df = pd.read_csv(
            StringIO(r.text),
            comment='#',
            header=None,
            names=[
                "id", "dateadded", "url", "status", "dateverified",
                "threat", "tags", "urlhaus_link", "reporter"
            ],
            engine='python',
            on_bad_lines='skip'
        )
        df = df[['url']]
        df['label'] = 'malware'
        return df

    def append_to_merged_csv(self, new_df):
        if os.path.exists(MERGED_CSV_PATH):
            merged_df = pd.read_csv(MERGED_CSV_PATH)
            # Avoid duplicates based on 'url'
            merged_df = pd.concat([merged_df, new_df], ignore_index=True)
            merged_df.drop_duplicates(subset='url', inplace=True)
        else:
            merged_df = new_df

        merged_df.to_csv(MERGED_CSV_PATH, index=False)
        self.stdout.write(f"Appended {len(new_df)} rows to {MERGED_CSV_PATH}")
